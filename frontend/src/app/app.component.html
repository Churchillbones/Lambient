<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar" [class.collapsed]="sidebarCollapsed">
    <div class="sidebar-header">
      <h2><i class="fas fa-cog"></i> Configuration</h2>
    </div>

    <!-- Azure Configuration -->
    <div class="sidebar-section">
      <h3>Azure Configuration</h3>
      <div class="form-group">
        <label class="form-label">Azure OpenAI API Key</label>
        <input type="password" class="form-control" placeholder="Enter API key" [(ngModel)]="config.azureApiKey">
      </div>
      <div class="form-group">
        <label class="form-label">Azure OpenAI Endpoint</label>
        <input type="text" class="form-control" placeholder="https://your-resource.openai.azure.com/" [(ngModel)]="config.azureEndpoint">
      </div>
    </div>

    <!-- Note Generation -->
    <div class="sidebar-section">
      <h3>Note Generation</h3>
      <div class="form-group">
        <label class="form-label">Note Model</label>
        <select class="form-control" [(ngModel)]="config.noteModel" (change)="saveConfiguration()">
          <option value="azure">Azure OpenAI (GPT-4)</option>
          <option value="local">Local LLM Model</option>
        </select>
      </div>
      <div class="form-group" *ngIf="config.noteModel === 'local'">
        <label class="form-label">Local Model</label>
        <select class="form-control" [(ngModel)]="config.localModel" (change)="saveConfiguration()">
          <option *ngFor="let model of localModelOptions" [value]="model.value" [title]="model.description">
            {{model.label}}
          </option>
        </select>
        <small class="form-text text-muted">{{getLocalModelDescription()}}</small>
      </div>
      <div class="checkbox-group" style="margin-top:8px;">
        <input type="checkbox" id="agentPipeline" [(ngModel)]="config.useAgentPipeline" (change)="saveConfiguration()">
        <label for="agentPipeline">Use Agent Pipeline</label>
      </div>
      <div class="form-group" *ngIf="config.useAgentPipeline" style="margin-top:12px;">
        <label class="form-label">Agent Settings (JSON)</label>
        <textarea class="form-control" rows="6" [(ngModel)]="config.agentSettings" (change)="saveConfiguration()" placeholder='{"setting":"value"}'></textarea>
        <small class="form-text text-muted">Provide JSON for custom agent behaviour. Invalid JSON will be ignored.</small>
      </div>
    </div>

    <!-- Speech Recognition -->
    <div class="sidebar-section">
      <h3>Speech Recognition</h3>
      <div class="form-group">
        <label class="form-label">ASR Engine</label>
        <select class="form-control" [(ngModel)]="config.asrEngine" (change)="onAsrEngineChange()">
          <option value="vosk">Vosk</option>
          <option value="whisper">Whisper</option>
          <option value="azure">Azure Speech</option>
        </select>
      </div>
      <div class="form-group" *ngIf="config.asrEngine === 'vosk'">
        <label class="form-label">Vosk Model</label>
        <select class="form-control" [(ngModel)]="config.voskModel">
          <option value="vosk-model-small-en-us-0.15">vosk-model-small-en-us-0.15</option>
          <option value="vosk-model-en-us-0.22">vosk-model-en-us-0.22</option>
        </select>
      </div>
      <div class="form-group" *ngIf="config.asrEngine === 'whisper'">
        <label class="form-label">Whisper Size</label>
        <select class="form-control" [(ngModel)]="config.whisperModel">
          <option value="tiny">tiny</option>
          <option value="base">base</option>
          <option value="medium">medium</option>
        </select>
      </div>
    </div>

    <!-- Security Settings -->
    <div class="sidebar-section">
      <h3>Security</h3>
      <div class="checkbox-group">
        <input type="checkbox" id="encryption" [(ngModel)]="config.encryptRecordings">
        <label for="encryption">Encrypt recordings on save</label>
      </div>
      <button class="btn btn-warning btn-sm" (click)="resetConfiguration()" style="margin-top: 10px;">
        Reset Config
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <h1>
        <i class="fas fa-stethoscope"></i>
        Lambient Scribe and Medical Transcription and AI Note Generation
      </h1>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <button class="btn btn-primary" (click)="exportResults()">
          <i class="fas fa-download"></i>
          Export
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab" [class.active]="activeTab === 'record'" (click)="switchTab('record')">
        <i class="fas fa-microphone"></i> Record Audio
      </div>
      <div class="tab" [class.active]="activeTab === 'upload'" (click)="switchTab('upload')">
        <i class="fas fa-upload"></i> Upload Audio
      </div>
      <div class="tab" [class.active]="activeTab === 'view'" (click)="switchTab('view')">
        <i class="fas fa-file-upload"></i> Upload Transcript / Note Generation
      </div>
      <div class="tab" [class.active]="activeTab === 'templates'" (click)="switchTab('templates')">
        <i class="fas fa-file-medical"></i> Note Library / Prompt Library
      </div>
      <div class="tab" [class.active]="activeTab === 'compare'" (click)="switchTab('compare')">
        <i class="fas fa-balance-scale"></i> Model Comparison
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Record Tab -->
      <div *ngIf="activeTab === 'record'" class="fade-in">
        <!-- Consent Box -->
        <div class="consent-box" [class.approved]="consentDocumented">
          <div class="consent-header" *ngIf="!consentDocumented">
            <i class="fas fa-clipboard-check"></i>
            Patient Consent Documentation
          </div>
          <div class="consent-header" *ngIf="consentDocumented">
            <i class="fas fa-check-circle"></i>
            CONSENT RECORDED
          </div>
          <p *ngIf="!consentDocumented">The patient was informed of the presence of a listening and transcribing tool during the visit and given the option to opt out and agreed to proceed.</p>
          <p *ngIf="consentDocumented">Patient has been informed and has agreed to proceed with recording and transcription.</p>
          <div class="form-group" style="margin-top: 16px;" *ngIf="!consentDocumented">
            <input type="text" class="form-control" placeholder="Patient Name" [(ngModel)]="patientName">
          </div>
          <div *ngIf="consentDocumented" style="margin-top: 16px;">
            <strong>Patient:</strong> {{patientName}}<br>
            <strong>Date:</strong> {{consentDate | date}}<br>
            <strong>Time:</strong> {{consentDate | date:'shortTime'}}
          </div>
          <button class="btn btn-warning btn-lg btn-full" *ngIf="!consentDocumented" (click)="documentConsent()">
            <i class="fas fa-check-circle"></i>
            Document Patient Consent
          </button>
        </div>

        <!-- Recording Mode Selection -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-cog"></i> Transcription Mode
            </h3>
          </div>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="mode" value="traditional" [(ngModel)]="recordingMode">
              Traditional Recording
            </label>
            <label class="radio-option">
              <input type="radio" name="mode" value="realtime" [(ngModel)]="recordingMode">
              Real-time ASR
            </label>
          </div>
        </div>

        <!-- Recording Controls -->
        <div class="recording-controls">
          <button class="btn btn-success btn-lg" [disabled]="isRecording" (click)="startRecording()">
            <i class="fas fa-play"></i> Start Recording
          </button>
          <button class="btn btn-warning btn-lg" [disabled]="!isRecording" (click)="pauseRecording()">
            <i class="fas fa-pause"></i> Pause
          </button>
          <button class="btn btn-danger btn-lg" [disabled]="!isRecording" (click)="stopRecording()">
            <i class="fas fa-stop"></i> Stop
          </button>
        </div>

        <!-- Real-time Transcription Display -->
        <div class="transcription-display" [class.recording]="isRecording">
          <div class="recording-indicator" *ngIf="isRecording">
            <div class="recording-dot"></div>
            RECORDING - <span>{{recordingTime}}</span>
          </div>
          <div class="transcription-text">
            <span *ngIf="finalTranscriptionText || partialTranscriptionText; else placeholder">
              {{finalTranscriptionText}}<span class="partial-text">{{partialTranscriptionText}}</span>
            </span>
            <ng-template #placeholder>
              <span class="placeholder-text" *ngIf="isRecording && recordingMode === 'realtime'">
                Listening for speech...
              </span>
              <span class="placeholder-text" *ngIf="!isRecording || recordingMode !== 'realtime'">
                Real-time transcription will appear here when recording...
              </span>
            </ng-template>
          </div>
          <div class="confidence-low" *ngIf="lowConfidenceWords.length > 0">
            Low confidence words: <span>{{lowConfidenceWords.join(', ')}}</span>
          </div>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step" [class.active]="currentStep === 0" [class.completed]="currentStep > 0">
            <div class="step-circle">1</div>
            <div class="step-label">Record</div>
          </div>
          <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
            <div class="step-circle">2</div>
            <div class="step-label">Transcribe</div>
          </div>
          <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
            <div class="step-circle">3</div>
            <div class="step-label">Clean</div>
          </div>
          <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
            <div class="step-circle">4</div>
            <div class="step-label">Generate Note</div>
          </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" *ngIf="showResults">
          <div class="result-box">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-file-alt"></i> Raw Transcription
              </div>
              <div class="result-actions">
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(rawTranscription)">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-secondary btn-sm" (click)="downloadText(rawTranscription, 'raw-transcription.txt')">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <p>{{rawTranscription || 'Transcription will appear here...'}}</p>
            </div>
          </div>

          <div class="result-box">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-broom"></i> Cleaned Transcription
              </div>
              <div class="result-actions">
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(cleanedTranscription)">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <p>{{cleanedTranscription || 'Cleaned transcription with corrected medical terminology...'}}</p>
            </div>
          </div>

          <div class="result-box">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-users"></i> Speaker Diarization
              </div>
              <div class="result-actions">
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(speakerDiarization)">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <div [innerHTML]="speakerDiarization || '<p><strong>Doctor:</strong> How are you feeling today?</p><p><strong>Patient:</strong> I\'ve been experiencing some discomfort...</p>'"></div>
            </div>
          </div>

          <div class="result-box">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-notes-medical"></i> Generated Medical Note
              </div>
              <div class="result-actions">
                <button class="btn btn-primary btn-sm" (click)="editNote()">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(generatedNote)">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-secondary btn-sm" (click)="downloadText(generatedNote, 'medical-note.txt')">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <div [innerHTML]="generatedNote || '<h4>SOAP Note</h4><p><strong>Subjective:</strong> Patient reports...</p><p><strong>Objective:</strong> Vital signs...</p><p><strong>Assessment:</strong> Clinical impression...</p><p><strong>Plan:</strong> Treatment recommendations...</p>'"></div>
            </div>
          </div>
        </div>

        <!-- Template Selection -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-medical"></i> Select Template
            </h3>
          </div>
          <div class="form-group" style="margin-bottom: 24px;">
            <label class="form-label" style="font-size: 16px; font-weight: 600;">Template</label>
            <select class="form-control" [(ngModel)]="config.selectedTemplate" (change)="saveConfiguration()" style="font-size: 14px;">
              <option *ngFor="let template of templateOptions" [value]="template.value" [title]="template.description">
                {{template.label}} {{template.isCustom ? '(Custom)' : ''}}
              </option>
            </select>
            <small class="form-text text-muted">{{getTemplateDescription()}}</small>
          </div>
        </div>

        <!-- Template Preview -->
        <div class="result-box" style="margin-bottom:24px;">
          <div class="result-header">
            <div class="result-title">
              <i class="fas fa-eye"></i> Template Preview
            </div>
            <div class="result-actions">
              <button class="btn btn-secondary btn-sm" (click)="selectTemplateForEditing(getTemplateByValue(config.selectedTemplate)); openTemplateManager()">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(getCurrentTemplatePrompt())">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          <div class="result-content" style="max-height:150px; overflow-y:auto; font-size:13px; white-space: pre-wrap;">
            {{getCurrentTemplatePrompt()}}
          </div>
        </div>
      </div>

      <!-- Upload Tab -->
      <div *ngIf="activeTab === 'upload'">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-cloud-upload-alt"></i> Upload Audio File
            </h3>
          </div>
          <div class="upload-area" 
               (dragover)="onDragOver($event)" 
               (dragleave)="onDragLeave($event)" 
               (drop)="onDrop($event)"
               (click)="fileInput.click()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 16px;"></i>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Drag and drop your audio file here, or click to browse</p>
            <button class="btn btn-primary">Choose File</button>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Supported formats: WAV, MP3, M4A</p>
            <input #fileInput type="file" accept="audio/*" style="display: none;" (change)="onFileSelected($event)">
          </div>

          <!-- Template Selection -->
          <div class="form-group" style="margin-top: 24px;">
            <label class="form-label" style="font-size: 16px; font-weight: 600;">Template</label>
            <select class="form-control" [(ngModel)]="config.selectedTemplate" (change)="saveConfiguration()" style="font-size: 14px;">
              <option *ngFor="let template of templateOptions" [value]="template.value" [title]="template.description">
                {{template.label}} {{template.isCustom ? '(Custom)' : ''}}
              </option>
            </select>
            <small class="form-text text-muted">{{getTemplateDescription()}}</small>
          </div>

          <!-- Template Preview -->
          <div class="result-box" style="margin-bottom:24px;">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-eye"></i> Template Preview
              </div>
              <div class="result-actions">
                <button class="btn btn-secondary btn-sm" (click)="selectTemplateForEditing(getTemplateByValue(config.selectedTemplate)); openTemplateManager()">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(getCurrentTemplatePrompt())">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="result-content" style="max-height:150px; overflow-y:auto; font-size:13px; white-space: pre-wrap;">
              {{getCurrentTemplatePrompt()}}
            </div>
          </div>

          <!-- Progress Steps -->
          <div class="progress-steps" style="margin-top:16px;" *ngIf="isTranscribing || showResults">
            <div class="step" [class.active]="currentStep === 0" [class.completed]="currentStep > 0">
              <div class="step-circle">1</div>
              <div class="step-label">Upload &amp; Transcribe</div>
            </div>
            <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
              <div class="step-circle">2</div>
              <div class="step-label">Clean</div>
            </div>
            <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
              <div class="step-circle">3</div>
              <div class="step-label">Generate Note</div>
            </div>
            <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
              <div class="step-circle">4</div>
              <div class="step-label">Complete</div>
            </div>
          </div>

          <div *ngIf="selectedFile" class="alert alert-info" style="margin-top: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-file-audio"></i>
                <span>{{selectedFile.name}} ({{(selectedFile.size / 1024 / 1024).toFixed(2)}} MB)</span>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary btn-sm" 
                        [disabled]="isTranscribing"
                        (click)="clearSelectedFile(); fileInput.value=''"
                        title="Remove selected file">
                  <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-primary" 
                        [disabled]="isTranscribing"
                        (click)="uploadAndTranscribe()">
                  <i *ngIf="!isTranscribing" class="fas fa-upload"></i>
                  <i *ngIf="isTranscribing" class="fas fa-spinner fa-spin"></i>
                  {{isTranscribing ? 'Processing...' : 'Upload & Transcribe'}}
                </button>
              </div>
            </div>
          </div>

          <!-- Audio Preview -->
          <div *ngIf="selectedFileUrl" style="margin-top: 16px; text-align: center;">
            <audio [src]="selectedFileUrl" controls style="width: 100%; max-width: 600px;"></audio>
          </div>

          <!-- Transcription Status -->
          <div *ngIf="isTranscribing" class="alert alert-warning" style="margin-top: 16px;">
            <i class="fas fa-cog fa-spin"></i>
            <strong>Transcription in Progress...</strong>
            <div style="margin-top: 8px;">
              <span *ngIf="currentStep === 1">Uploading and transcribing audio file...</span>
              <span *ngIf="currentStep === 2">Cleaning and correcting transcription...</span>
              <span *ngIf="currentStep === 3">Generating medical note...</span>
              <span *ngIf="currentStep === 4">Finalizing results...</span>
            </div>
          </div>

          <!-- Results Section (mirrors Record tab) -->
          <div class="results-section" *ngIf="showResults" style="margin-top: 32px;">
            <div class="result-box">
              <div class="result-header">
                <div class="result-title">
                  <i class="fas fa-file-alt"></i> Raw Transcription
                </div>
                <div class="result-actions">
                  <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(rawTranscription)">
                    <i class="fas fa-copy"></i>
                  </button>
                  <button class="btn btn-secondary btn-sm" (click)="downloadText(rawTranscription, 'raw-transcription.txt')">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="result-content">
                <p>{{rawTranscription || 'Transcription will appear here...'}}</p>
              </div>
            </div>

            <div class="result-box">
              <div class="result-header">
                <div class="result-title">
                  <i class="fas fa-broom"></i> Cleaned Transcription
                </div>
                <div class="result-actions">
                  <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(cleanedTranscription)">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              <div class="result-content">
                <p>{{cleanedTranscription || 'Cleaned transcription with corrected medical terminology...'}}</p>
              </div>
            </div>

            <div class="result-box">
              <div class="result-header">
                <div class="result-title">
                  <i class="fas fa-users"></i> Speaker Diarization
                </div>
                <div class="result-actions">
                  <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(speakerDiarization)">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              <div class="result-content">
                <div [innerHTML]="speakerDiarization || '<p><strong>Doctor:</strong> How are you feeling today?</p><p><strong>Patient:</strong> I\'ve been experiencing some discomfort...</p>'"></div>
              </div>
            </div>

            <div class="result-box">
              <div class="result-header">
                <div class="result-title">
                  <i class="fas fa-notes-medical"></i> Generated Medical Note
                </div>
                <div class="result-actions">
                  <button class="btn btn-primary btn-sm" (click)="editNote()">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(generatedNote)">
                    <i class="fas fa-copy"></i>
                  </button>
                  <button class="btn btn-secondary btn-sm" (click)="downloadText(generatedNote, 'medical-note.txt')">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="result-content">
                <div [innerHTML]="generatedNote || '<h4>SOAP Note</h4><p><strong>Subjective:</strong> Patient reports...</p><p><strong>Objective:</strong> Vital signs...</p><p><strong>Assessment:</strong> Clinical impression...</p><p><strong>Plan:</strong> Treatment recommendations...</p>'"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Templates Tab -->
      <div *ngIf="activeTab === 'templates'" class="fade-in">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-medical"></i> Note Library / Prompt Library
            </h3>
            <button class="btn btn-primary" (click)="startCreatingNewTemplate(); openTemplateManager()">
              <i class="fas fa-plus"></i> Create New Template
            </button>
          </div>

          <!-- Current Template Selection -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label class="form-label" style="font-size: 16px; font-weight: 600;">Active Template</label>
            <select class="form-control" [(ngModel)]="config.selectedTemplate" (change)="saveConfiguration()" style="font-size: 14px;">
              <option *ngFor="let template of templateOptions" [value]="template.value" [title]="template.description">
                {{template.label}} {{template.isCustom ? '(Custom)' : ''}}
              </option>
            </select>
            <small class="form-text text-muted">{{getTemplateDescription()}}</small>
          </div>

          <!-- Current Template Preview -->
          <div class="result-box" style="margin-bottom: 24px;">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-eye"></i> Current Template Prompt
              </div>
              <div class="result-actions">
                <button class="btn btn-secondary btn-sm" (click)="selectTemplateForEditing(getTemplateByValue(config.selectedTemplate)); openTemplateManager()"
                        title="Edit template">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(getCurrentTemplatePrompt())">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <pre style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; line-height: 1.5;">{{getCurrentTemplatePrompt() || 'No template selected'}}</pre>
            </div>
          </div>

          <!-- Template Library -->
          <div class="card">
            <div class="card-header">
              <h4 style="margin: 0; font-size: 16px;">
                <i class="fas fa-th-list"></i> Template Library
              </h4>
            </div>
            <div class="template-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; padding: 16px;">
              <div *ngFor="let template of templateOptions" class="template-card" 
                   [class.active]="template.value === config.selectedTemplate"
                   style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; background: var(--surface); cursor: pointer; transition: var(--transition);"
                   (click)="config.selectedTemplate = template.value; saveConfiguration()">
                <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 8px;">
                  <div style="flex: 1;">
                    <h5 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 600;">
                      {{template.label}}
                      <span *ngIf="template.isCustom" style="background: #e3f2fd; color: #1565c0; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">CUSTOM</span>
                    </h5>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">{{template.description}}</p>
                  </div>
                  <div class="template-actions" style="display: flex; gap: 4px; margin-left: 8px;">
                    <button class="btn btn-secondary btn-sm" 
                            style="padding: 4px 8px; font-size: 11px;"
                            (click)="selectTemplateForEditing(template); openTemplateManager(); $event.stopPropagation()"
                            title="Edit template">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button *ngIf="template.isCustom" 
                            class="btn btn-danger btn-sm" 
                            style="padding: 4px 8px; font-size: 11px;"
                            (click)="deleteTemplate(template); $event.stopPropagation()"
                            title="Delete custom template">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div style="font-size: 11px; color: var(--text-secondary); background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px; max-height: 60px; overflow: hidden; position: relative;">
                  {{template.prompt.substring(0, 150)}}{{template.prompt.length > 150 ? '...' : ''}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Template Manager Modal -->
      <div *ngIf="showTemplateManager" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" (click)="closeTemplateManager()">
        <div class="modal-content" style="background: white; border-radius: 8px; padding: 24px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;" (click)="$event.stopPropagation()">
          <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">
              <i class="fas fa-edit"></i>
              {{isCreatingNewTemplate ? 'Create New Template' : 'Edit Template'}}
            </h3>
            <button class="btn btn-secondary btn-sm" (click)="closeTemplateManager()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="modal-body">
            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label" style="font-weight: 600;">Template Name</label>
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="editingTemplateName" 
                     placeholder="Enter template name (e.g., 'Custom SOAP Note')"
                     style="font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 24px;">
              <label class="form-label" style="font-weight: 600;">Template Prompt</label>
              <small class="form-text text-muted" style="display: block; margin-bottom: 8px;">
                This is the prompt that will be sent to the AI model to format the transcription.
                Include specific formatting instructions and structure requirements.
              </small>
              <textarea class="form-control" 
                        [(ngModel)]="editingTemplatePrompt" 
                        rows="20" 
                        placeholder="Enter the template prompt..."
                        style="font-family: 'Monaco', 'Consolas', monospace; font-size: 13px; line-height: 1.4;"></textarea>
            </div>

            <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--border-color);">
              <button class="btn btn-secondary" (click)="closeTemplateManager()">
                Cancel
              </button>
              <button class="btn btn-primary" (click)="saveTemplate()">
                <i class="fas fa-save"></i>
                {{isCreatingNewTemplate ? 'Create Template' : 'Save Changes'}}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- View Tab -->
      <div *ngIf="activeTab === 'view'" class="fade-in">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-upload"></i> Upload Transcript
            </h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Paste Transcript Text</label>
              <textarea class="form-control" rows="10" [(ngModel)]="rawTranscription" placeholder="Paste transcript text here..."></textarea>
            </div>
            <div class="form-group" style="margin-top:16px;">
              <label class="form-label">Or Upload Transcript File (.txt)</label>
              <input type="file" accept=".txt" (change)="onTranscriptFileSelected($event)">
            </div>
            <div class="form-group" style="margin-top: 24px;">
              <label class="form-label" style="font-size: 16px; font-weight: 600;">Template</label>
              <select class="form-control" [(ngModel)]="config.selectedTemplate" (change)="saveConfiguration()" style="font-size: 14px;">
                <option *ngFor="let template of templateOptions" [value]="template.value" [title]="template.description">
                  {{template.label}} {{template.isCustom ? '(Custom)' : ''}}
                </option>
              </select>
              <small class="form-text text-muted">{{getTemplateDescription()}}</small>
            </div>

            <!-- Template Preview -->
            <div class="result-box" style="margin-bottom:24px;">
              <div class="result-header">
                <div class="result-title">
                  <i class="fas fa-eye"></i> Template Preview
                </div>
                <div class="result-actions">
                  <button class="btn btn-secondary btn-sm" (click)="selectTemplateForEditing(getTemplateByValue(config.selectedTemplate)); openTemplateManager()">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(getCurrentTemplatePrompt())">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              <div class="result-content" style="max-height:150px; overflow-y:auto; font-size:13px; white-space: pre-wrap;">
                {{getCurrentTemplatePrompt()}}
              </div>
            </div>

            <!-- Progress Steps -->
            <div class="progress-steps" style="margin-top:16px;">
              <div class="step" [class.active]="currentStep === 0" [class.completed]="currentStep > 0">
                <div class="step-circle">1</div>
                <div class="step-label">Load</div>
              </div>
              <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
                <div class="step-circle">2</div>
                <div class="step-label">Clean</div>
              </div>
              <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
                <div class="step-circle">3</div>
                <div class="step-label">Generate Note</div>
              </div>
              <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
                <div class="step-circle">4</div>
                <div class="step-label">Complete</div>
              </div>
            </div>

            <!-- Action Button -->
            <button class="btn btn-primary btn-lg" style="margin-top:24px;" (click)="processTranscriptText()" [disabled]="isTranscribing || !rawTranscription">
              <span *ngIf="isTranscribing" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="margin-right:8px;"></span>
              <i class="fas" [ngClass]="isTranscribing ? 'fa-hourglass-half' : 'fa-play'"></i>
              {{ isTranscribing ? 'Processing...' : 'Generate Note' }}
            </button>

            <!-- Processing Status -->
            <div *ngIf="isTranscribing" class="alert alert-warning" style="margin-top: 16px;">
              <i class="fas fa-cog fa-spin"></i>
              <strong>Processing Transcript...</strong>
              <div style="margin-top: 8px;">
                <span *ngIf="currentStep === 0">Loading transcript...</span>
                <span *ngIf="currentStep === 1">Cleaning transcript...</span>
                <span *ngIf="currentStep === 2">Generating medical note...</span>
                <span *ngIf="currentStep === 3">Finalizing results...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Section (re-using existing variables) -->
        <div class="results-section" *ngIf="showResults" style="margin-top:32px;">
          <div class="result-box">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-file-alt"></i> Raw Transcription
              </div>
              <div class="result-actions">
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(rawTranscription)">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-secondary btn-sm" (click)="downloadText(rawTranscription, 'raw-transcription.txt')">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <p>{{rawTranscription || 'Transcription will appear here...'}}</p>
            </div>
          </div>

          <div class="result-box">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-broom"></i> Cleaned Transcription
              </div>
              <div class="result-actions">
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(cleanedTranscription)">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <p>{{cleanedTranscription || 'Cleaned transcription with corrected medical terminology...'}}</p>
            </div>
          </div>

          <div class="result-box">
            <div class="result-header">
              <div class="result-title">
                <i class="fas fa-notes-medical"></i> Generated Medical Note
              </div>
              <div class="result-actions">
                <button class="btn btn-primary btn-sm" (click)="editNote()">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-secondary btn-sm" (click)="copyToClipboard(generatedNote)">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-secondary btn-sm" (click)="downloadText(generatedNote, 'medical-note.txt')">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            </div>
            <div class="result-content">
              <div [innerHTML]="generatedNote || '<h4>SOAP Note</h4><p><strong>Subjective:</strong> Patient reports...</p><p><strong>Objective:</strong> Vital signs...</p><p><strong>Assessment:</strong> Clinical impression...</p><p><strong>Plan:</strong> Treatment recommendations...</p>'"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Compare Tab -->
      <div *ngIf="activeTab === 'compare'">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-balance-scale"></i> Select Models to Compare
            </h3>
          </div>
          <div class="comparison-container">
            <div class="comparison-box">
              <div class="comparison-header">Model 1</div>
              <div class="form-group">
                <label class="form-label">Model Type</label>
                <select class="form-control" [(ngModel)]="comparison.model1.type">
                  <option value="vosk">Vosk</option>
                  <option value="whisper">Whisper</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Model Size</label>
                <select class="form-control" [(ngModel)]="comparison.model1.size">
                  <option value="small">Small</option>
                  <option value="base">Base</option>
                  <option value="medium">Medium</option>
                </select>
              </div>
            </div>
            <div class="comparison-box">
              <div class="comparison-header">Model 2</div>
              <div class="form-group">
                <label class="form-label">Model Type</label>
                <select class="form-control" [(ngModel)]="comparison.model2.type">
                  <option value="whisper">Whisper</option>
                  <option value="vosk">Vosk</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Model Size</label>
                <select class="form-control" [(ngModel)]="comparison.model2.size">
                  <option value="tiny">Tiny</option>
                  <option value="base">Base</option>
                  <option value="medium">Medium</option>
                </select>
              </div>
            </div>
          </div>
          <button class="btn btn-primary btn-lg" style="margin-top: 24px;" (click)="runComparison()">
            <i class="fas fa-play"></i> Run Comparison
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
